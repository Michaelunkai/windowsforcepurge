{% extends "base.html" %}

{% block title %}Dashboard - TodoNotes{% endblock %}

{% block content %}
<div class="dashboard-container">
    <div class="dashboard-header">
        <h1>Welcome back! ðŸ‘‹</h1>
        <p>Here's what's happening with your tasks and notes today.</p>
    </div>

    <!-- Statistics Cards -->
    <div class="stats-grid">
        <div class="stat-card">
            <div class="stat-icon">
                <i class="fas fa-tasks"></i>
            </div>
            <div class="stat-content">
                <h3>{{ total_tasks }}</h3>
                <p>Total Tasks</p>
            </div>
        </div>
        
        <div class="stat-card">
            <div class="stat-icon">
                <i class="fas fa-check"></i>
            </div>
            <div class="stat-content">
                <h3>{{ completed_tasks }}</h3>
                <p>Completed</p>
            </div>
        </div>
        
        <div class="stat-card">
            <div class="stat-icon">
                <i class="fas fa-sticky-note"></i>
            </div>
            <div class="stat-content">
                <h3>{{ recent_notes|length }}</h3>
                <p>Recent Notes</p>
            </div>
        </div>
        
        <div class="stat-card">
            <div class="stat-icon">
                <i class="fas fa-folder"></i>
            </div>
            <div class="stat-content">
                <h3>{{ projects|length }}</h3>
                <p>Projects</p>
            </div>
        </div>
    </div>

    <!-- Quick Actions -->
    <div class="quick-actions">
        <h2>Quick Actions</h2>
        <div class="action-buttons">
            <button class="action-btn primary" onclick="showTaskModal()">
                <i class="fas fa-plus"></i>
                <span>Add Task</span>
            </button>
            <a href="/notes/create" class="action-btn secondary">
                <i class="fas fa-file-plus"></i>
                <span>Create Note</span>
            </a>
        </div>
    </div>

    <!-- Dashboard Content Grid -->
    <div class="dashboard-grid">
        <!-- Recent Tasks -->
        <div class="dashboard-card">
            <div class="card-header">
                <h3><i class="fas fa-clock"></i> Recent Tasks</h3>
                <a href="/tasks" class="view-all">View All</a>
            </div>
            <div class="card-content">
                {% if recent_tasks %}
                    {% for task in recent_tasks %}
                    <div class="task-item">
                        <div class="task-checkbox">
                            <input type="checkbox" id="task-{{ task.id }}" {% if task.completed %}checked{% endif %} 
                                   onchange="toggleTask({{ task.id }})">
                            <label for="task-{{ task.id }}"></label>
                        </div>
                        <div class="task-content">
                            <h4 class="{% if task.completed %}completed{% endif %}">{{ task.title }}</h4>
                            <p>{{ task.description[:50] }}{% if task.description|length > 50 %}...{% endif %}</p>
                            <div class="task-meta">
                                {% if task.project %}
                                <span class="project-tag" style="background-color: {{ task.project.color }}20; color: {{ task.project.color }}">
                                    {{ task.project.name }}
                                </span>
                                {% endif %}
                                <span class="priority priority-{{ task.priority }}">
                                    {% if task.priority == 4 %}Urgent{% elif task.priority == 3 %}High{% elif task.priority == 2 %}Medium{% else %}Low{% endif %}
                                </span>
                            </div>
                        </div>
                    </div>
                    {% endfor %}
                {% else %}
                    <div class="empty-state">
                        <i class="fas fa-tasks"></i>
                        <p>No tasks yet. Create your first task!</p>
                    </div>
                {% endif %}
            </div>
        </div>

        <!-- Recent Notes -->
        <div class="dashboard-card">
            <div class="card-header">
                <h3><i class="fas fa-sticky-note"></i> Recent Notes</h3>
                <a href="/notes" class="view-all">View All</a>
            </div>
            <div class="card-content">
                {% if recent_notes %}
                    {% for note in recent_notes %}
                    <div class="note-item">
                        <div class="note-content">
                            <h4>{{ note.title }}</h4>
                            <p>{{ note.content|striptags|truncate(100) }}</p>
                            <div class="note-meta">
                                {% if note.folder %}
                                <span class="folder-tag" style="background-color: {{ note.folder.color }}20; color: {{ note.folder.color }}">
                                    <i class="fas fa-folder"></i> {{ note.folder.name }}
                                </span>
                                {% endif %}
                                <span class="note-date">{{ note.updated_at.strftime('%b %d') }}</span>
                            </div>
                        </div>
                        <div class="note-actions">
                            <a href="/notes/{{ note.id }}/edit" class="btn-icon">
                                <i class="fas fa-edit"></i>
                            </a>
                        </div>
                    </div>
                    {% endfor %}
                {% else %}
                    <div class="empty-state">
                        <i class="fas fa-sticky-note"></i>
                        <p>No notes yet. Create your first note!</p>
                    </div>
                {% endif %}
            </div>
        </div>

        <!-- Projects -->
        <div class="dashboard-card full-width">
            <div class="card-header">
                <h3><i class="fas fa-folder-open"></i> Projects</h3>
                <button class="btn btn-primary" onclick="showProjectModal()">
                    <i class="fas fa-plus"></i> New Project
                </button>
            </div>
            <div class="card-content">
                {% if projects %}
                <div class="projects-grid">
                    {% for project in projects %}
                    <div class="project-card" data-project-id="{{ project.id }}" style="border-left: 4px solid {{ project.color }}">
                        <div class="project-header">
                            <h4>{{ project.name }}</h4>
                            <div class="project-stats">
                                <span class="task-count">{{ project.tasks|length }} tasks</span>
                            </div>
                        </div>
                        <p>{{ project.description }}</p>
                        <div class="project-actions">
                            <a href="/tasks?project_id={{ project.id }}" class="btn btn-sm">View Tasks</a>
                            <button class="btn btn-sm btn-secondary" onclick="editProject({{ project.id }})">
                                <i class="fas fa-edit"></i> Edit
                            </button>
                            <button class="btn btn-sm btn-danger" onclick="deleteProject({{ project.id }})">
                                <i class="fas fa-trash"></i> Delete
                            </button>
                        </div>
                    </div>
                    {% endfor %}
                </div>
                {% else %}
                    <div class="empty-state">
                        <i class="fas fa-folder-open"></i>
                        <p>No projects yet. Create your first project!</p>
                    </div>
                {% endif %}
            </div>
        </div>
    </div>
</div>

<!-- Task Modal -->
<div id="taskModal" class="modal">
    <div class="modal-content">
        <div class="modal-header">
            <h3>Create New Task</h3>
            <button class="modal-close" onclick="hideTaskModal()">&times;</button>
        </div>
        <form action="/tasks/create" method="post" class="modal-form">
            <div class="form-group">
                <label for="task-title">Task Title</label>
                <input type="text" id="task-title" name="title" required class="form-input">
            </div>
            
            <div class="form-group">
                <label for="task-description">Description</label>
                <textarea id="task-description" name="description" class="form-textarea" rows="3"></textarea>
            </div>
            
            <div class="form-row">
                <div class="form-group">
                    <label for="task-priority">Priority</label>
                    <select id="task-priority" name="priority" class="form-select">
                        <option value="1">Low</option>
                        <option value="2" selected>Medium</option>
                        <option value="3">High</option>
                        <option value="4">Urgent</option>
                    </select>
                </div>
                
                <div class="form-group">
                    <label for="task-project">Project</label>
                    <select id="task-project" name="project_id" class="form-select">
                        <option value="">No Project</option>
                        {% for project in projects %}
                        <option value="{{ project.id }}">{{ project.name }}</option>
                        {% endfor %}
                    </select>
                </div>
            </div>
            
            <div class="form-group">
                <label for="task-due-date">Due Date</label>
                <input type="date" id="task-due-date" name="due_date" class="form-input">
            </div>
            
            <div class="modal-actions">
                <button type="button" class="btn btn-secondary" onclick="hideTaskModal()">Cancel</button>
                <button type="submit" class="btn btn-primary">Create Task</button>
            </div>
        </form>
    </div>
</div>

<!-- Project Modal -->
<div id="projectModal" class="modal">
    <div class="modal-content">
        <div class="modal-header">
            <h3 id="projectModalTitle">Create New Project</h3>
            <button class="modal-close" onclick="hideProjectModal()">&times;</button>
        </div>
        <form id="projectForm" action="/projects/create" method="post" class="modal-form">
            <div class="form-group">
                <label for="project-name">Project Name</label>
                <input type="text" id="project-name" name="name" required class="form-input">
            </div>
            
            <div class="form-group">
                <label for="project-description">Description</label>
                <textarea id="project-description" name="description" class="form-textarea" rows="3" placeholder="What's this project about?"></textarea>
            </div>
            
            <div class="form-group">
                <label for="project-color">Color</label>
                <div class="color-picker">
                    <input type="radio" name="color" value="#e74c3c" id="project-color-red">
                    <label for="project-color-red" class="color-option" style="background-color: #e74c3c"></label>
                    
                    <input type="radio" name="color" value="#2ecc71" id="project-color-green">
                    <label for="project-color-green" class="color-option" style="background-color: #2ecc71"></label>
                    
                    <input type="radio" name="color" value="#3498db" id="project-color-blue" checked>
                    <label for="project-color-blue" class="color-option" style="background-color: #3498db"></label>
                    
                    <input type="radio" name="color" value="#9b59b6" id="project-color-purple">
                    <label for="project-color-purple" class="color-option" style="background-color: #9b59b6"></label>
                    
                    <input type="radio" name="color" value="#f39c12" id="project-color-orange">
                    <label for="project-color-orange" class="color-option" style="background-color: #f39c12"></label>
                    
                    <input type="radio" name="color" value="#34495e" id="project-color-dark">
                    <label for="project-color-dark" class="color-option" style="background-color: #34495e"></label>
                </div>
            </div>
            
            <div class="modal-actions">
                <button type="button" class="btn btn-secondary" onclick="hideProjectModal()">Cancel</button>
                <button type="submit" class="btn btn-primary" id="projectSubmitBtn">Create Project</button>
            </div>
        </form>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
function showTaskModal() {
    document.getElementById('taskModal').style.display = 'flex';
}

function hideTaskModal() {
    document.getElementById('taskModal').style.display = 'none';
}

async function toggleTask(taskId) {
    try {
        const response = await fetch(`/tasks/${taskId}/toggle`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            }
        });
        
        if (response.ok) {
            location.reload();
        }
    } catch (error) {
        console.error('Error toggling task:', error);
    }
}

// Project Management Functions
function showProjectModal() {
    document.getElementById('projectModalTitle').textContent = 'Create New Project';
    document.getElementById('projectSubmitBtn').textContent = 'Create Project';
    document.getElementById('projectForm').action = '/projects/create';
    document.getElementById('projectForm').reset();
    document.getElementById('projectModal').style.display = 'flex';
}

function hideProjectModal() {
    document.getElementById('projectModal').style.display = 'none';
}

async function editProject(projectId) {
    try {
        // Fetch project data
        const response = await fetch(`/projects/${projectId}`);
        if (!response.ok) throw new Error('Project not found');
        
        const project = await response.json();
        
        // Populate form
        document.getElementById('project-name').value = project.name;
        document.getElementById('project-description').value = project.description;
        
        // Set color
        const colorInput = document.querySelector(`input[name="color"][value="${project.color}"]`);
        if (colorInput) colorInput.checked = true;
        
        // Update modal
        document.getElementById('projectModalTitle').textContent = 'Edit Project';
        document.getElementById('projectSubmitBtn').textContent = 'Update Project';
        document.getElementById('projectForm').action = `/projects/${projectId}/edit`;
        document.getElementById('projectModal').style.display = 'flex';
        
    } catch (error) {
        console.error('Error loading project:', error);
        alert('Error loading project data');
    }
}

async function deleteProject(projectId) {
    if (!confirm('Are you sure you want to delete this project? All tasks will be unassigned from this project.')) {
        return;
    }
    
    try {
        const response = await fetch(`/projects/${projectId}`, {
            method: 'DELETE',
            headers: {
                'Content-Type': 'application/json',
            }
        });
        
        if (response.ok) {
            // Show success message
            if (window.todoNotesApp) {
                window.todoNotesApp.showNotification('Project deleted successfully!', 'success');
            }
            
            // Remove project card from UI with animation
            const projectCard = document.querySelector(`[data-project-id="${projectId}"]`);
            if (projectCard) {
                projectCard.style.animation = 'slideOut 0.3s ease';
                setTimeout(() => {
                    projectCard.remove();
                    // If no projects left, show empty state
                    const projectsGrid = document.querySelector('.projects-grid');
                    if (projectsGrid && projectsGrid.children.length === 0) {
                        location.reload();
                    }
                }, 300);
            } else {
                location.reload();
            }
        } else {
            throw new Error('Failed to delete project');
        }
    } catch (error) {
        console.error('Error deleting project:', error);
        alert('Error deleting project');
    }
}

// Close modals when clicking outside
window.onclick = function(event) {
    const projectModal = document.getElementById('projectModal');
    const taskModal = document.getElementById('taskModal');
    
    if (event.target === projectModal) {
        hideProjectModal();
    }
    if (event.target === taskModal) {
        hideTaskModal();
    }
}
</script>
{% endblock %}